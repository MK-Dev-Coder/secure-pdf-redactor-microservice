name: Deploy to AKS

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - aks-migration

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Build and Push Redaction Service
      run: |
        ACR_LOGIN_SERVER=${{ secrets.ACR_NAME }}.azurecr.io
        az acr login --name ${{ secrets.ACR_NAME }}
        
        docker build -t $ACR_LOGIN_SERVER/redaction-service:${{ github.sha }} ./redaction_service
        docker build -t $ACR_LOGIN_SERVER/redaction-service:latest ./redaction_service
        docker push $ACR_LOGIN_SERVER/redaction-service:${{ github.sha }}
        docker push $ACR_LOGIN_SERVER/redaction-service:latest

    - name: Build and Push Frontend Web
      run: |
        ACR_LOGIN_SERVER=${{ secrets.ACR_NAME }}.azurecr.io
        
        docker build -t $ACR_LOGIN_SERVER/frontend-web:${{ github.sha }} ./frontend_web
        docker build -t $ACR_LOGIN_SERVER/frontend-web:latest ./frontend_web
        docker push $ACR_LOGIN_SERVER/frontend-web:${{ github.sha }}
        docker push $ACR_LOGIN_SERVER/frontend-web:latest

    - name: Set AKS Context
      uses: azure/aks-set-context@v3
      with:
        resource-group: ${{ secrets.RESOURCE_GROUP }}
        cluster-name: ${{ secrets.AKS_CLUSTER_NAME }}

    - name: Replace Image Placeholders
      run: |
        ACR_LOGIN_SERVER=${{ secrets.ACR_NAME }}.azurecr.io
        sed -i "s|REPLACE_WITH_ACR_NAME|$ACR_LOGIN_SERVER|g" k8s/redaction.yaml
        sed -i "s|REPLACE_WITH_ACR_NAME|$ACR_LOGIN_SERVER|g" k8s/frontend.yaml

    - name: Deploy to AKS
      run: |
        kubectl apply -f k8s/consul.yaml
        kubectl apply -f k8s/redaction.yaml
        kubectl apply -f k8s/frontend.yaml
